# VFPX Deployment

These instructions describe how to use VFPX Deployment to include your project in the Thor Check for Updates (CFU) dialog so users can easily install your project and update to the latest version without having to clone your project's repository or manually download and extract a ZIP file.

![](./Images/ThorCFUDialog.png)

## Overview

To make it easier to create the files necessary to support Thor CFU, an automated build process is used. The main component of this process is Thor_Tools_DeployVFPXProject.prg, a generic program that works with any project. After doing the necessary set up (discussed in the next section), you'll run Thor_Tools_DeployVFPXProject.prg whenever you release a new version of your project.

In addition to whatever subdirectories your project root folder contains, it will also contain BuildProcess, InstalledFiles, and ThorUpdater subdirectories.

* BuildProcess contains the files for the build process:

    * ProjectSettings.txt: contains project settings, such as project name and version number.
    
    * VersionTemplate.txt: contains the template for the Thor CFU version file. Although it has a TXT extension, it actually contains VFP code.
    
    * BuildMe.prg: contains custom code you write to do whatever is necessary for the build process. It can use public variables created by VFPX Deployment (discussed later). This program is optional.
    
    * Thor_Update_*AppID*.prg (where *AppID* is the value of the AppID setting in ProjectSettings.txt): the Thor CFU update program, which contains the URLs for Thor to use to download the version and ZIP files to install the tool. This file is created the first time you use the VFPX Deployment process and then not updated again after that.
    
    * InstalledFiles.txt: contain the paths for the files to be installed by Thor CFU. This file is optional.

* InstalledFiles: this is a staging folder that contains only the files Thor CFU should install, not other files related to your project (such as Git-related files, README.md, etc.). There are two options for copying the necessary files into this folder:

    * If InstalledFiles.txt exists in the BuildProcess folder, VFPX Deployment copies the files listed in it to the InstalledFiles folder (creating that folder and any subdirectories of it if they don't exist).
    
    * You can manually create the InstalledFiles folder and copy the necessary files into it.

* ThorUpdater: this contains the Thor CFU files generated by the build process (VFPX Deployment creates this folder if necessary):

    * *AppID*.zip (*AppID* is the AppID value specified in ProjectSettings.txt): the zip file downloaded by Thor CFU to install the project. This file is created by VFPX Deployment by zipping the contents of the InstalledFiles folder.
    
    * *AppID*Version.txt: the Thor version file downloaded by Thor CFU to decide if a newer version is available (it compares the version number specified in this file with the version number in the copy of the file on your system) and also to contain other information such as the text displayed for the selected project at the bottom of the Thor CFU dialog.

The VFPX Deployment process does the following:

* Creates the BuildProcess subdirectory of the project folder and copies the files listed above to it.

* Reads the settings in ProjectSettings.txt (see the next section for a list of the settings in this file) into the following public variables so BuildMe.prg can read from or write to them if necessary:

    * pcAppName: the AppName setting
    
    * pcAppID: the AppID setting
    
    * pcVersion: the version number (the Version setting but can also be set in code; see the next section)

    * pdVersionDate: the release date (the VersionDate setting or the current date if not specified)
    
    * pcVersionDate: the release date as a string (YYYY-MM-DD)
    
    * pcChangeLog: the ChangeLog setting
    
    * plContinue: .T. to continue the deployment process or .F. to stop

* Prompts for the version number if necessary (see below).

* Runs BuildMe.prg if it exists. If BuildMe.prg sets plContinue to .F., the build process terminates.

* If the settings in ProjectSettings.txt specify an APP or EXE is to be built, that task is done.

* If InstalledFiles.txt exists, creates the InstalledFiles folder if necessary and copies the files listed in InstalledFiles.txt to it (preserving relative paths).

* Creates the ThorUpdater folder if necessary and creates *AppID*Version.txt in that folder by copying VersionTemplate.txt to it and substituting placeholders in the content with the appropriate values (see below).

* Creates Thor_Update_*AppID*.prg in the BuildProcess folder (the first time only).

* Zips the contents of the InstalledFiles folder into *AppID*.zip in the ThorUpdater folder.

* Adds *AppID*Version.txt and *AppID*.zip to the Git repository for the project.

## Setting up the build process

This looks like a lot of steps but most of it is simple and you only have to do it once.

### 1. Download the VFPX Deployment tool

* Choose Check for Updates from the Thor menu and install VFPX Deployment. It's automatically added to the Thor Tools menu under Applications, VFPX Project Deployment.

### 2. Customize the project settings for your project

Start VFP, CD to the folder containing your project, and invoke the VFPX Deployment tool (from the Thor Tools, Application, VFPX Project Deployment menu item or using ```EXECSCRIPT(_screen.cThorDispatcher, 'Thor_Tool_DeployVFPXProject')```. The first time you do that, it'll create a BuildProcess subdirectory of the project folder, copy some files to it, and terminate.

Edit ProjectSettings.txt to specify your project information (the case of these settings is unimportant):

![](./Images/ProjectSettings.png)

* AppName: the display name for the project.

* AppID: similar to appName but must be URL-friendly (no spaces or other illegal URL characters).

* Version: the version number, such as 1.0 (optional; see below).

You can also add the following optional settings if you wish:

* VersionDate: the release date formatted as YYYY-MM-DD; if omitted, today's date is used.

* Prompt: Yes to prompt for Version if it isn't specified; No to not prompt. Not required if Version is specified. If Version isn't specified, your code in BuildMe.prg can set the public pcVersion variable (for example, by reading a value from an INI or include file), so set Prompt to No in that case. If Version isn't specified, Prompt is No, and your code doesn't set pcVersion, a warning message is displayed and the build process terminates.

* ChangeLog: the path for a file containing changes (see below).

* Component: Yes if this project is a Thor Component (meaning it doesn't have to be registered with Thor and is installed in Thor\Tools\Components) or No if it's a Thor App (meaning it does have to be registered with Thor and is installed in Thor\Tools\Apps). If this is omitted, "Yes" is used.

* Category: the category to use when adding to the Thor menu. If this is omitted, "Applications" is used. This is only used when Component is No.

* PJXFile: the relative path to the PJX file to build an APP or EXE from. Omit this if that isn't required.

* AppFile: the path to the APP or EXE to build from the project (specified with the extension; for example, MyApp.app builds an APP and MyApp.exe builds an EXE). If PJXFile is specified and AppFile is omitted, VFPX Deployment automatically builds an APP file in the same folder and with the same file name as the PJX file specified in the PJXFile setting.

    > If ProjectSettings.txt specifies that an APP or EXE is part of the project, VFPX Deployment ensures it's built using VFP 9 and not VFP Advanced because the APP/EXE structure is different. While VFP Advanced can run APP/EXEs created in VFP 9, VFP 9 cannot run APP/EXEs created in VFP Advanced.

* Bin2PRGFolder: the path to the source code folder to which [FoxBin2PRG](https://github.com/fdbozzo/foxbin2prg) is to be applied. If this is specified, FoxBin2PRG is run on all VFP binary files (SCX, VCX, PJX, etc.) in the specified folder to create their text equivalents. This is important because Git cannot do diffs on binary files.

    > FoxBin2PRG is automatically run on the project file specified in the PJXFile setting. If PJXFile is specified and the only files that need to have FoxBin2PRG run on them are included in the project, you can omit the Bin2PRGFolder setting.

* Repository: when VFPX Deployment generates Thor_Update_*AppID*.prg, it assumes the project repository is github.com/VFPX/*AppID*. If your project exists in a different location (for example, github.com/*YourName*/*AppID*), add a Repository setting with the full URL, such as ```https://github.com/DougHennig/SFMail```.

### 3. Specify what files are installed

Edit InstalledFiles.txt and list each file to be copied to the InstalledFiles folder on a separate line. All paths should be relative to the project root folder.

![](./Images/InstalledFiles.png)

### 4. Optional: customize the version template

VersionTemplate.txt already has the code most projects would use. However, you may wish to edit it to customize the behavior; see comments in the provided file for possible customization points. Also note the use of @@@ and \\\\\\\: text between those delimiters is for you to read but is removed in the *AppID*Version.txt file that's generated from the template.

The code in this file must accept a single parameter, which is a Thor CFU updater object. The code typically sets properties of that object to do whatever is necessary.

The template file should have placeholders for project settings (the case of the placeholder isn't important):

* {APPNAME}: substituted with the value of pcAppName.

* {APPID}: substituted with the value of pcAppID.

* {VERSIONDATE}: substituted with the value of pdVersionDate formatted as YYYYMMDD.

* {VERSION}: substituted with the value of pcVersion.

* {JULIAN}: substituted with the value of pdVersionDate as a numeric value: the Julian date since 2000-01-01. If you wish, you can use that as a minor version number (see the example below).

* {CHANGELOG}: substituted with the contents of the file specified in pcChangeLog.

* {COMPONENT}: substituted with the value of the Component setting in ProjectSettings.txt.

* {CATEGORY}: substituted with the value of the Category setting in ProjectSettings.txt.

The format of AvailableVersion in VersionTemplate.txt&mdash;the project name, a dash, the version number, a dash, some text, a dash, and the release date formatted as YYYYMMDD&mdash;is required by Thor (Thor actually only uses the version number and release date and ignores the rest).

See comments in VersionTemplate.txt about how to use different types of version numbers.

### 5. Optional: customize the build tasks

If you need to perform specific tasks as part of the build process, such as updating version numbers in code or include files, edit BuildMe.prg to perform those tasks. It can use the public variables created by VFPX Deployment (discussed earlier). If the Version setting isn't specified in ProjectSettings.txt and the prompt setting is N, set the pcVersion variable to the appropriate value.

If no specific tasks are needed beyond what the VFPX Deployment process does, you can delete BuildMe.prg.

## Running the build process

After doing all of the tasks in the previous section, you're ready to create the files Thor needs to download and install or update your project. This is the normal deployment process you'll use each time there's a new release for your project:

1. Make whatever changes to your project files are necessary.

2. Update ProjectSettings.txt with a new version number if necessary. For example, if you use the Version setting as the version number, increment it. If you use Version as the major version number and the Julian date as a minor version number, and this is just a minor release (e.g. going from 3.2.1234 to 3.2.1245), you don't need to change Version at all.

3. If you've specified the ChangeLog setting in ProjectSettings.txt, update the specified file to describe the changes.

4. Invoke the VFPX Deployment tool from the Thor Tools, Application, VFPX Project Deployment menu item or using ```EXECSCRIPT(_screen.cThorDispatcher, 'Thor_Tool_DeployVFPXProject')```.

5. Commit and push to the remote repository.

### First time task

In order for Thor to know about your project, it needs a Thor updater program named Thor_Update_*AppID*.prg. The build process creates that PRG in the BuildProcess folder and then doesn't update it again after that.

You can test that the updater PRG works by copying it to Thor\Tools\Updates\My Updates under your Thor installation folder. Then choose Check for Updates from the Thor menu. The tool should appear in the CFU dialog in italics, and installing it should work.

Once you confirm the update process works, zip Thor_Update_*AppID*.prg and email it to the VFPX administrators (<a href="mailto:projects@vfpx.org">projects@vfpx.org</a>). They'll add it to the Thor repository so Thor knows about your project.

> Note to admins: see [How to contribute to Thor](https://github.com/VFPX/Thor/blob/master/.github/CONTRIBUTING.md) for instructions to handle the new Thor_Update_*AppID*.prg.

### Checking for updates

Now that Thor knows about your project, the next time a user chooses Check for Updates from the Thor menu in VFP, Thor will download *AppID*Version.txt from the ThorUpdater folder of your repository, see that the project is available to be installed or a new version is ready for download, and display it to the user in the update dialog.

If the user chooses to install the project or the update, Thor downloads *AppID*.zip from the ThorUpdater folder of your repository and unzips it in the appropriate folder on your machine (the *AppName* subdirectory of either the Thor\Tools\Apps or Thor\Tools\Components, depending on the Component setting in ProjectSettings.txt, subdirectory of the main Thor folder) and creates *AppID*VersionFile.txt in that folder so it knows what version the user has so they aren't prompted about an update until the next release.
