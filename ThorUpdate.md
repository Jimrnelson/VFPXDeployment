---
layout: page
permalink: /thorupdate/
---

# Supporting Thor Updater

These instructions describe how to include your project in the Thor Check for Updates (CFU) dialog so users can easily install your project and update to the latest version without having to clone your project's repository or manually download and extract a ZIP file.

## Overview

To make it easier to create the files necessary to support Thor CFU, an automated build process is used. The main component of this process is Deploy.prg, a generic program that works with any project. After doing the necessary set up (discussed in the next section), you'll run Deploy.prg whenever you release a new version of your project.

In addition to whatever subdirectories your project root folder contains, it will also contain BuildProcess, InstalledFiles, and ThorUpdater subdirectories.

* BuildProcess contains the files for the build process:

    * Deploy.prg: the main build process component, provided as part of the download (discussed later).
    
    * BuildMe.prg: contains custom code you write to do whatever is necessary for the build process, such as building an APP or EXE. It can use public variables created by Deploy.prg (discussed later). This program is optional.
    
    * ProjectSettings.txt: contains project settings, such as project name and version number. For backward compatibility, the file can also be named Project.txt.
    
    * VersionTemplate.txt: contains the template for the Thor CFU version file. Although it has a TXT extension, it actually contains VFP code. For backward compatibility, the file can also be named Version.txt.
    
    * InstalledFiles.txt: contain the paths for the files to be installed by Thor CFU. This file is optional.

* InstalledFiles: this is a staging folder that contains only the files Thor CFU should install, not other files related to your project (such as Git-related files, README.md, etc.). There are two options for copying the necessary files into this folder:

    * If InstalledFiles.txt exists in the BuildProcess folder, Deploy.prg copies the files listed in it to the InstalledFiles folder (creating that folder and any subdirectories of it if they don't exist).
    
    * You can manually create the InstalledFiles folder and copy the necessary files into it.

* ThorUpdater: this contains the Thor CFU files generated by the build process (Deploy.prg creates this folder if necessary):

    * *AppID*.zip (*AppID* is the AppID value specified in ProjectSettings.txt): the zip file downloaded by Thor CFU to install the project. This file is created by Deploy.prg by zipping the contents of the InstalledFiles folder.
    
    * *AppID*Version.txt: the Thor version file downloaded by Thor CFU to decide if a newer version is available (it compares the version number specified in this file with the version number in the copy of the file on your system) and also to contain other information such as the text displayed for the selected project at the bottom of the Thor CFU dialog.

        ![](images/ThorCFUDialog.png)

    * Thor_Update_*AppID*.prg: the Thor update program. It contains settings that tell Thor the name of your project and the URL to download it from. This file, which is discussed in more detail in the next section, doesn't have to go in the ThorUpdater folder but this is a convenient place to put it.

Deploy.prg does the following:

* Reads the settings in ProjectSettings.txt (see the next section for a list of the settings in this file) into the following public variables so BuildMe.prg can read from or write to them if necessary:

    * pcAppName: the AppName setting
    
    * pcAppID: the AppID setting
    
    * pcVersion: the version number (the Version setting but can also be set in code; see the next section)

    * pdVersionDate: the release date (the VersionDate setting or the current date if not specified)
    
    * pcVersionDate: the release date as a string (YYYY-MM-DD)
    
    * pcChangeLog: the ChangeLog setting
    
    * plContinue: .T. to continue the deployment process or .F. to stop

* Prompts for the version number if necessary (see below).

* Runs BuildMe.prg if it exists. If BuildMe.prg sets plContinue to .F., the build process terminates.

* If InstalledFiles.txt exists, creates the InstalledFiles folder if necessary and copies the files listed in InstalledFiles.txt to it (preserving relative paths).

* Creates the ThorUpdater folder if necessary and creates *AppID*Version.txt in that folder by copying VersionTemplate.txt to it and substituting placeholders in the content with the appropriate values (see below).

* Zips the contents of the InstalledFiles folder into *AppID*.zip in the ThorUpdater folder.

## Setting up the build process

This looks like a lot of steps but most of it is simple and you only have to do it once.

### 1. Download the build process files

* Create a subdirectory of your project folder named BuildProcess.

* Download [ThorUpdater.zip](https://vfpx.github.io/ThorUpdater/ThorUpdater.zip) and unzip it in the BuildProcess folder. This zip file contains Deploy.prg, BuildMe.prg, ProjectSettings.txt, VersionTemplate.txt, Thor_Update_Template.prg, and Thor_Update_Template_With_Menu.prg.

* Because they were downloaded, Deploy.prg and BuildMe.prg are blocked by default. Right-click Deploy.prg, choose Properties, turn on Unblock, and click OK. Repeat for BuildMe.prg. If you don't see an Unblock button, it should be fine.

    ![](images/unblock.png)

### 2. Customize the project settings

Edit ProjectSettings.txt to specify your project information (the case of these settings is unimportant):

* AppName: the display name for the project.

* AppID: similar to appName but must be URL-friendly (no spaces or other illegal URL characters).

* Version: the version number, such as 1.0 (optional; see below).

You can also add the following three optional settings if you wish:

* VersionDate: the release date formatted as YYYY-MM-DD; if omitted, today's date is used.

* Prompt: Y to prompt for Version if it isn't specified; N to not prompt. Not required if Version is specified. If Version isn't specified, your code in BuildMe.prg can set the public pcVersion variable (for example, by reading a value from an INI or include file), so set Prompt to N in that case. If Version isn't specified, Prompt is N, and your code doesn't set pcVersion, a warning message is displayed and the build process terminates.

* ChangeLog: the path for a file containing changes (see below).

### 3. Customize the version template

Edit VersionTemplate.txt or create your own. The code in this file must accept a single parameter, which is a Thor CFU updater object. The code typically sets properties of that object to do whatever is necessary. The provided file has this code:

```foxpro
lparameters toUpdateObject
toUpdateObject.AvailableVersion = '{APPNAME}-{VERSION}-update-{VERSIONDATE}'
return toUpdateObject
```
All it does is set the Available version property of the updater object. Your code, of course, can be considerably more complex if necessary.

This template file should have placeholders for project settings (the case of the placeholder isn't important):

* {VERSION}: substituted with the value of pcVersion.

* {VERSIONDATE}: substituted with the value of pdVersionDate formatted as YYYYMMDD.

* {APPNAME}: substituted with the value of pcAppName.

* {APPID}: substituted with the value of pcAppID.

* {JULIAN}: substituted with the value of pdVersionDate as a numeric value: the Julian date since 2000-01-01. If you wish, you can use that as a minor version number (see the example below).

* {CHANGELOG}: substituted with the contents of the file specified in pcChangeLog.

For example, if ProjectSettings.txt contains this:

    AppName = Project Explorer  
    AppID   = ProjectExplorer  
    Version = 1.0

then if run on October 12, 2017, Deploy.prg generates ProjectExplorerVersion.txt in the ThorUpdater folder with this content:

```
lparameters toUpdateObject
toUpdateObject.AvailableVersion = 'Project Explorer-1.0-update-20171012'
return toUpdateObject
```
The format of AvailableVersion in VersionTemplate.txt&mdash;the project name, a dash, the version number, a dash, some text, a dash, and the release date formatted as YYYYMMDD&mdash;is required by Thor (Thor actually only uses the version number and release date and ignores the rest).

Some projects use the Julian date as a minor version number. In that case, use the {JULIAN} placeholder in VersionTemplate.txt. For example:

```foxpro
lparameters toUpdateObject
toUpdateObject.AvailableVersion = '{APPNAME}-{VERSION}.{JULIAN}-update-{VERSIONDATE}'
return toUpdateObject
```

If run on October 12, 2017 with the same ProjectSettings.txt above, Deploy.prg generates:

```
lparameters toUpdateObject
toUpdateObject.AvailableVersion = 'Project Explorer-1.0.6494-update-20171012'
return toUpdateObject
```

Here's another example. In this case, the content of the change log file specified in ProjectSettings.txt (which is presumably included in the repository and linked to from README.md) will be included in *AppID*Version.txt so it appears in the Thor CFU dialog.

```foxpro
lparameters toUpdateObject
local lcDate, ldDate
lcDate = '{VersionDate}'
with toUpdateObject
    .VersionNumber = '{Version} - ' + lcDate
    .AvailableVersion = '{AppName}-{Version}-update-' + lcDate
    .Notes = GetReleaseNotes()
endwith
return toUpdateObject

procedure GetReleaseNotes
text to lcNote noshow
{ChangeLog}
endtext
return lcNote
```

### 4. Customize the build tasks

If you need to perform specific tasks as part of the build process, such as building an APP or EXE, updating version numbers in code or include files, edit BuildMe.prg to perform those tasks. It can use the public variables created by Deploy.prg (discussed earlier). If the Version setting isn't specified in ProjectSettings.txt and the prompt setting is N, set the pcVersion variable to the appropriate value.

If an APP or EXE is part of the project, you should ensure it's built using VFP 9 and not VFP Advanced (if you use that) because the APP/EXE structure is different. While VFP Advanced can run APP/EXEs created in VFP 9, VFP 9 cannot run APP/EXEs created in VFP Advanced. To do that, use the following code:

```foxpro
if val(version(4)) > 9
    messagebox('You must run Deploy.prg using VFP 9 not VFP Advanced.', ;
        16, 'Project Deployment')
    plContinue = .F.
    return
endif
```

If no specific tasks are needed beyond what Deploy.prg does, you can delete BuildMe.prg.

### 5. Create the Thor CFU program

In order for Thor to know about your project, you have to create a Thor updater program named Thor_Update_*AppID*.prg. Thor_Update_Template.prg and Thor_Update_Template_With_Menu.prg are templates you can use for such a program (use the latter if you want your tool to appear in the Thor menu); see the comments in the appropriate PRG about what to edit to make it specific for your project.

*** TODO: discuss testing it: put it in Thor\Tools\Updates\My Updates. Then when CFU runs it shows up in italics.

After creating this program, zip it and email it to the VFPX administrators (<a href="mailto:projects@vfpx.org">projects@vfpx.org</a>). They'll add it to the Thor repository so Thor knows about your project (note to admins: download Updates.zip from the ThorUpdater folder of https://github.com/VFPX/Thor, add the PRG to the zip, and re-upload the file). You only have to do this one time.

## Running the build process

After doing all of the tasks in the previous section, you're ready to create the files Thor needs to download and install or update your project. Run Deploy.prg in the BuildProcess folder.

After it's finished, add *AppID*Version.txt and *AppID*.zip to your Git repository (only necessary the first time you run Deploy.prg). Commit and push to the remote repository.

Now that Thor knows about your project, the next time a user chooses Check for Updates from the Thor menu in VFP, Thor will download *AppID*Version.txt from the ThorUpdater folder of your repository, see that the project is available to be installed or a new version is ready for download, and display it to the user in the update dialog. If the user chooses to install the project or the update, Thor downloads *AppID*.zip from the ThorUpdater folder of your repository and unzips it in the appropriate folder on your machine (the *AppName* subdirectory of either the Thor\Tools\Apps or Thor\Tools\Components [depending on the ***TODO: WHICH SETTING setting in VersionTemplate.txt] subdirectory of the main Thor folder) and creates *AppID*VersionFile.txt in that folder so it knows what version the user has so they aren't prompted about an update until the next release.
